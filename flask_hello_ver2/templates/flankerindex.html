<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>フランカー課題</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/css/bootstrap.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .stimulus-container {
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 80px;
            font-weight: normal;
            font-family: monospace;
            background-color: white;
            border-radius: 8px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .progress {
            height: 30px;
            margin-bottom: 20px;
        }
        .instructions {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .key-instruction {
            font-weight: bold;
            margin: 10px 0;
        }
        .hidden {
            display: none;
        }
        .results-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            padding: 20px;
        }
        .summary-table {
            width: 100%;
            margin-bottom: 20px;
        }
        .summary-table th {
            background-color: #f0f0f0;
        }
        .result-highlight {
            font-weight: bold;
            color: #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center my-4">フランカー課題</h1>
        
        {% if template == 'index' %}
            <!-- 指示画面 -->
            <div id="instructions" class="instructions">
                <h3>実験の説明</h3>
                <p>これはフランカー課題と呼ばれる認知実験です。画面の中央に表示される矢印の方向に応じて素早くキーを押してください。</p>
                
                <div class="key-instruction">
                    <p>中央の矢印が「&lt;」の場合：「c」キーを押してください（刺激表示後）</p>
                    <p>中央の矢印が「&gt;」の場合：「m」キーを押してください（刺激表示後）</p>
                    <p class="text-primary">※刺激表示中だけでなく、その後のブランク画面（+表示）中も反応できます</p>
                </div>
                
                <p>例：「&gt;&gt;&lt;&gt;&gt;」の場合、中央は「&lt;」なので左矢印キーを押します。</p>
                <p>「&lt;&lt;&lt;&lt;&lt;」の場合、中央は「&lt;」なので左矢印キーを押します。</p>
                
                <p class="mt-3">各刺激は0.3秒間だけ表示され、その後1.5秒間は「+」が表示されます。</p>
                <p>できるだけ速く、正確に反応してください。</p>
                
                <div class="form-group mb-3">
                    <label for="trials-input">各刺激の試行回数（デフォルト：5回）</label>
                    <input type="number" id="trials-input" class="form-control" min="1" max="20" value="5">
                </div>
                
                <button id="start-button" class="btn btn-primary btn-lg d-block mx-auto mt-4">実験を開始</button>
            </div>
            
            <!-- 実験画面 -->
            <div id="experiment" class="hidden">
                <div class="progress">
                    <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
                
                <div class="stimulus-container">
                    <span id="stimulus">+</span>
                </div>
                
                <div class="text-center">
                    <p>現在の試行: <span id="current-trial">0</span> / <span id="total-trials">0</span></p>
                    <p>左の場合は「c」キー、右の場合は「m」キーを押して反応してください</p>
                </div>
            </div>
            
            <!-- 読み込み中表示 -->
            <div id="loading" class="hidden text-center my-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">結果を計算中...</p>
            </div>
            
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    // 要素の参照を取得
                    const instructionsDiv = document.getElementById('instructions');
                    const experimentDiv = document.getElementById('experiment');
                    const loadingDiv = document.getElementById('loading');
                    const startButton = document.getElementById('start-button');
                    const trialsInput = document.getElementById('trials-input');
                    const stimulusElement = document.getElementById('stimulus');
                    const progressBar = document.getElementById('progress-bar');
                    const currentTrialElement = document.getElementById('current-trial');
                    const totalTrialsElement = document.getElementById('total-trials');
                    
                    // 実験の状態変数
                    let isWaitingForResponse = false;
                    let experimentActive = false;
                    let totalTrials = 0;
                    let currentTrial = 0;
                    let trialStartTime = 0;
                    
                    // ベースURLを取得（現在のパスから）
                    const basePath = window.location.pathname.split('/').slice(0, -1).join('/') || '/flanker';
                    
                    // スタートボタンのイベントリスナー
                    startButton.addEventListener('click', function() {
                        const trialsPerStimulus = parseInt(trialsInput.value) || 5;
                        
                        // サーバーに実験開始を通知
                        fetch(basePath + '/start', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: `trials_per_stimulus=${trialsPerStimulus}`
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                // 画面を実験表示に切り替え
                                instructionsDiv.classList.add('hidden');
                                experimentDiv.classList.remove('hidden');
                                
                                totalTrials = data.total_trials;
                                totalTrialsElement.textContent = totalTrials;
                                
                                // 実験を開始
                                experimentActive = true;
                                nextTrial();
                            }
                        });
                    });
                    
                    // キー入力のイベントリスナー
                    document.addEventListener('keydown', function(event) {
                        if (!experimentActive || !isWaitingForResponse) return;
                        
                        // デバッグ用ログ
                        console.log('キー押下:', event.key);
                        
                        let response = null;
                        
                        // キーを検出（大文字小文字を区別しない）
                        if (event.key.toLowerCase() === 'c') {
                            response = 'left';
                            console.log('左反応を検出');
                        } else if (event.key.toLowerCase() === 'm') {
                            response = 'right';
                            console.log('右反応を検出');
                        } else {
                            console.log('未対応のキー');
                            return; // 他のキーは無視
                        }
                        
                        // イベントのデフォルト動作を防止
                        event.preventDefault();
                        
                        isWaitingForResponse = false;
                        
                        // 反応時間を計算（ミリ秒）
                        const reactionTime = Date.now() - trialStartTime;
                        console.log(`反応時間: ${reactionTime}ms`);
                        
                        // サーバーに反応を送信
                        fetch(basePath + '/record_response', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                response: response,
                                reaction_time: reactionTime
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            console.log('サーバーレスポンス:', data);
                            // フィードバックは表示せず、次の試行へ
                            setTimeout(showBlank, 0);
                        })
                        .catch(error => {
                            console.error('エラー:', error);
                            setTimeout(showBlank, 0);
                        });
                    }, true); // useCapture を true に設定
                    
                    // 次の試行を取得して表示
                    function nextTrial() {
                        fetch(basePath + '/next_trial')
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'completed') {
                                // 実験終了
                                experimentActive = false;
                                experimentDiv.classList.add('hidden');
                                loadingDiv.classList.remove('hidden');
                                
                                // 結果ページへリダイレクト
                                setTimeout(() => {
                                    window.location.href = basePath + '/results';
                                }, 1000);
                                return;
                            }
                            
                            // 進捗を更新
                            currentTrial = data.trial_number;
                            currentTrialElement.textContent = currentTrial;
                            progressBar.style.width = `${(currentTrial / totalTrials) * 100}%`;
                            
                            // 最初は+を表示
                            stimulusElement.textContent = '+';
                            
                            // 一定時間後に刺激を表示
                            setTimeout(() => {
                                // 刺激を表示
                            // 刺激を表示
                                stimulusElement.innerHTML = data.stimulus_display || data.stimulus;
                                console.log('刺激表示:', data.stimulus);
                                
                                // 反応時間の計測方法を改善
                                trialStartTime = Date.now();
                                console.log('反応時間計測開始:', trialStartTime);
                                isWaitingForResponse = true;
                                
                                // 刺激表示時間後にブランク画面に戻す
                                setTimeout(() => {
                                    stimulusElement.textContent = '+';
                                    
                                    // ブランク画面でも反応を受け付ける（反応時間制限を延長）
                                    // 反応なし判定はこの段階では行わない
                                    console.log('刺激消失、ブランク表示中も反応を待機');
                                    // タイムアウト処理は行わない（ブランク中も反応可能）
                                }, data.stimulus_duration);
                            }, 1000); // 最初の試行は1秒後に開始
                        });
                    }
                    
                    // ブランク画面を表示して次の試行の準備
                    function showBlank() {
                        console.log('ブランク画面表示');
                        stimulusElement.textContent = '+';
                        
                        // ブランク時間後に次の試行へ
                        console.log(`${BLANK_DURATION}ms後に次の試行へ`);
                        
                        // ブランク時間終了時に反応がなければタイムアウトとして記録
                        setTimeout(() => {
                            if (isWaitingForResponse) {
                                console.log('ブランク時間終了、反応なし（タイムアウト）');
                                isWaitingForResponse = false;
                                
                                fetch(basePath + '/record_response', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({
                                        response: null,
                                        reaction_time: STIMULUS_DURATION + BLANK_DURATION
                                    })
                                })
                                .then(response => response.json())
                                .then(data => {
                                    console.log('タイムアウト記録完了:', data);
                                    nextTrial();
                                })
                                .catch(error => {
                                    console.error('タイムアウト記録エラー:', error);
                                    nextTrial();
                                });
                            } else {
                                nextTrial();
                            }
                        }, BLANK_DURATION);
                    }
                    
                    // 固定の時間（JavaScriptでも設定）
                    const BLANK_DURATION = 1500;
                    const STIMULUS_DURATION = 300;
                });
            </script>
        {% elif template == 'results' %}
            <!-- 結果画面 -->
            {% if error %}
                <div class="alert alert-danger">{{ error }}</div>
            {% else %}
                <!-- 結果サマリー -->
                <div class="results-card">
                    <h2>実験サマリー</h2>
                    <table class="table summary-table">
                        <tbody>
                            <tr>
                                <th>総試行数</th>
                                <td>{{ summary.total_trials }}</td>
                            </tr>
                            <tr>
                                <th>全体の正確率</th>
                                <td>{{ summary.accuracy }}%</td>
                            </tr>
                            <tr>
                                <th>平均反応時間 (正答のみ)</th>
                                <td>{{ summary.avg_rt }}ms</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <h3>条件別の結果</h3>
                    <table class="table summary-table">
                        <thead>
                            <tr>
                                <th>条件</th>
                                <th>正確率</th>
                                <th>平均反応時間</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>一致条件 (&lt;&lt;&lt;&lt;&lt;, &gt;&gt;&gt;&gt;&gt;)</td>
                                <td>{{ summary.congruent_accuracy }}%</td>
                                <td>{{ summary.congruent_avg_rt }}ms</td>
                            </tr>
                            <tr>
                                <td>不一致条件 (&lt;&lt;&gt;&lt;&lt;, &gt;&gt;&lt;&gt;&gt;)</td>
                                <td>{{ summary.incongruent_accuracy }}%</td>
                                <td>{{ summary.incongruent_avg_rt }}ms</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div class="result-highlight">
                        <p>干渉効果（不一致 - 一致の反応時間差）: {{ summary.interference_effect }}ms</p>
                        {% if summary.interference_effect > 0 %}
                            <p>干渉効果が観察されました。不一致条件で反応が遅くなる傾向があります。</p>
                        {% elif summary.interference_effect < 0 %}
                            <p>逆干渉効果が観察されました。不一致条件の方が反応が速い結果となっています。</p>
                        {% else %}
                            <p>干渉効果は観察されませんでした。</p>
                        {% endif %}
                    </div>
                </div>
                
                <!-- 試行ごとのデータ -->
                <div class="results-card">
                    <h2>試行データ</h2>
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>試行</th>
                                <th>刺激</th>
                                <th>条件</th>
                                <th>反応</th>
                                <th>反応時間 (ms)</th>
                                <th>正誤</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for trial in trial_data %}
                                <tr class="{{ 'table-danger' if not trial.is_correct else '' }}">
                                    <td>{{ trial.trial }}</td>
                                    <td>{{ trial.stimulus }}</td>
                                    <td>{{ '一致' if trial.trial_type == 'congruent' else '不一致' }}</td>
                                    <td>
                                        {% if trial.response == 'left' %}
                                            c (左)
                                        {% elif trial.response == 'right' %}
                                            m (右)
                                        {% else %}
                                            反応なし
                                        {% endif %}
                                    </td>
                                    <td>{{ trial.reaction_time }}</td>
                                    <td>{{ '正解' if trial.is_correct else '不正解' }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- 再実験ボタン -->
                <div class="text-center mb-5">
                    <a href="/" class="btn btn-primary btn-lg">もう一度実験する</a>
                </div>
            {% endif %}
        {% endif %}
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/js/bootstrap.bundle.min.js"></script>
</body>
</html>